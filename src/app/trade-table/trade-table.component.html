@if (isLoading()) {
  <div class="trades-table__loading" role="status" aria-live="polite">
    <mat-spinner diameter="50" aria-hidden="true"></mat-spinner>
    <span class="visually-hidden">Loading trades...</span>
  </div>
} @else {
  <table class="trades-table">
    <thead class="trades-table__head">
      <tr class="trades-table__row trades-table__row--head">
        <th class="trades-table__cell">Symbol</th>
        <th class="trades-table__cell">Order ID</th>
        <th class="trades-table__cell">Side</th>
        <th class="trades-table__cell">Size</th>
        <th class="trades-table__cell">Open Time</th>
        <th class="trades-table__cell">Open Price</th>
        <th class="trades-table__cell">Swap</th>
        <th class="trades-table__cell trades-table__cell--right">Profit</th>
        <th class="trades-table__cell trades-table__cell--action"></th>
      </tr>
    </thead>

    <tbody class="trades-table__body">
      @for (group of groupedTrades(); track group.symbol) {
        <tr
          class="trades-table__row trades-table__row--group"
          role="button"
          tabindex="0"
          (click)="toggle(group.symbol)"
          (keydown.enter)="toggle(group.symbol)"
          (keydown.space)="toggle(group.symbol); $event.preventDefault()"
          [attr.aria-expanded]="isExpanded(group.symbol)"
          [attr.aria-controls]="'group-' + group.symbol"
        >
          <td class="trades-table__cell trades-table__cell--symbol" data-label="Symbol">
            <mat-icon
              class="trades-table__chevron"
              [class.trades-table__chevron--open]="isExpanded(group.symbol)"
              aria-hidden="true"
            >
              keyboard_arrow_down
            </mat-icon>
            {{ group.symbol }}
            <span class="trades-table__badge">{{ group.count }}</span>
          </td>

          <td class="trades-table__cell" data-label="Order ID"></td>
          <td class="trades-table__cell" data-label="Side"></td>
          <td class="trades-table__cell" data-label="Size">
            {{ group.totalSize }}
          </td>
          <td class="trades-table__cell" data-label="Open Time"></td>
          <td class="trades-table__cell" data-label="Open Price">
            {{ group.avgOpenPrice | number: '1.5-5' }}
          </td>
          <td class="trades-table__cell" data-label="Swap">
            {{ group.totalSwap }}
          </td>
          <td
            class="trades-table__cell trades-table__cell--right"
            data-label="Profit"
            [class.trades-table__cell--profit]="group.totalProfit > 0"
            [class.trades-table__cell--loss]="group.totalProfit < 0"
          >
            {{ group.totalProfit | number: '1.5-5' }}
          </td>
          <td class="trades-table__cell trades-table__cell--action" data-label="Action">
            <button
              mat-icon-button
              (click)="$event.stopPropagation(); closeGroup(group)"
              [attr.aria-label]="'Close group ' + group.symbol"
            >
              <mat-icon aria-hidden="true">delete</mat-icon>
            </button>
          </td>
        </tr>

        @if (isExpanded(group.symbol)) {
          @for (trade of group.trades; track trade.id) {
            <tr class="trades-table__row trades-table__row--trade" [id]="'group-' + group.symbol">
              <td class="trades-table__cell" data-label="Symbol"></td>

              <td class="trades-table__cell" data-label="Order ID">
                {{ trade.id }}
              </td>

              <td class="trades-table__cell" data-label="Side">
                {{ trade.side }}
              </td>

              <td class="trades-table__cell" data-label="Size">
                {{ trade.size }}
              </td>

              <td class="trades-table__cell" data-label="Open Time">
                {{ trade.openTime | date: 'dd.MM.yyyy HH:mm:ss' }}
              </td>

              <td class="trades-table__cell" data-label="Open Price">
                {{ trade.openPrice }}
              </td>

              <td class="trades-table__cell" data-label="Swap">
                {{ trade.swap }}
              </td>

              <td
                class="trades-table__cell trades-table__cell--right"
                data-label="Profit"
                [class.trades-table__cell--profit]="trade.profit > 0"
                [class.trades-table__cell--loss]="trade.profit < 0"
              >
                {{ trade.profit | number: '1.5-5' }}
              </td>

              <td class="trades-table__cell trades-table__cell--action" data-label="Action">
                <button
                  mat-icon-button
                  (click)="closeOrder(trade.id)"
                  [attr.aria-label]="'Close order ' + trade.id"
                >
                  <mat-icon aria-hidden="true">close</mat-icon>
                </button>
              </td>
            </tr>
          }
        }
      }
    </tbody>
  </table>
}
